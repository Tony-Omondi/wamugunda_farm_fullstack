{% extends "base.html" %}
{% load static %}

{% block title %}Shopping Cart - Wamugunda Farm{% endblock %}

{% block content %}
<div class="breadcumb-wrapper" data-bg-src="{% static 'assets/img/bg/breadcumb-bg.jpg' %}">
    <div class="container">
        <div class="breadcumb-content">
            <h1 class="breadcumb-title">Shopping Cart</h1>
            <ul class="breadcumb-menu">
                <li><a href="{% url 'home' %}">Home</a></li>
                <li>Cart</li>
            </ul>
        </div>
    </div>
</div>

<div class="th-cart-wrapper space-top space-extra-bottom">
    <div class="container">
        {% if cart %}
        <div class="woocommerce-message alert alert-success mb-4">
            Shipping costs included according to your delivery zone
        </div>

        <form action="{% url 'cart:cart_update' %}" method="post" class="woocommerce-cart-form mb-5">
            {% csrf_token %}
            <table class="cart_table">
                <thead><tr>
                    <th>Image</th>
                    <th>Product</th>
                    <th>Price</th>
                    <th>Quantity</th>
                    <th>Total</th>
                    <th>Remove</th>
                </tr></thead>
                <tbody>
                    {% for item in cart %}
                    <tr>
                        <td><img src="{% if item.product.images.first %}{{ item.product.images.first.image.url }}{% else %}{% static 'assets/img/product/no-image.png' %}{% endif %}" width="80" class="rounded"></td>
                        <td><strong>{{ item.product.name }}</strong></td>
                        <td>KSh {{ item.price }}</td>
                        <td>
                            <div class="quantity">
                                <button type="button" class="qty-btn" onclick="updateQuantity('{{ item.product.id }}', -1)">−</button>
                                <input type="number" name="quantity_{{ item.product.id }}" value="{{ item.quantity }}" min="1" class="qty-input" readonly>
                                <button type="button" class="qty-btn" onclick="updateQuantity('{{ item.product.id }}', 1)">+</button>
                            </div>
                        </td>
                        <td><strong>KSh {{ item.total_price }}</strong></td>
                        <td><a href="{% url 'cart:cart_remove' item.product.id %}" onclick="return confirm('Remove?')"><i class="fal fa-trash-alt text-danger"></i></a></td>
                    </tr>
                    {% endfor %}
                    <tr>
                        <td colspan="6" class="text-end">
                            <button type="submit" class="th-btn me-3">Update Cart</button>
                            <a href="{% url 'shop:shop_list' %}" class="th-btn style2">Continue Shopping</a>
                        </td>
                    </tr>
                </tbody>
            </table>
        </form>

        <div class="row justify-content-end">
            <div class="col-md-8 col-lg-7 col-xl-6">
                <h2 class="h4 mb-4">Order Summary</h2>
                <table class="cart_totals bg-light p-4 rounded">
                    <tr><td>Subtotal</td><td class="text-end">KSh {{ cart.get_total_price }}</td></tr>
                    <tr>
                        <th>Delivery Zone</th>
                        <td>
                            <form method="post" action="{% url 'cart:set_shipping_zone' %}">{% csrf_token %}
                                <select name="shipping_zone" class="form-select" onchange="this.form.submit()">
                                    <option value="">-- Select Zone --</option>
                                    {% for zone, cost in shipping_zones.items %}
                                    <option value="{{ zone }}" {% if selected_zone == zone %}selected{% endif %}>{{ zone }} → KSh {{ cost }}</option>
                                    {% endfor %}
                                </select>
                            </form>
                            {% if selected_zone %}
                            <small class="text-success d-block mt-2">+ KSh {{ shipping_cost }} delivery</small>
                            {% endif %}
                        </td>
                    </tr>
                    <tr class="order-total">
                        <th><h4>Total</h4></th>
                        <td class="text-end"><h3 class="text-success">KSh {{ cart.get_total_price|add:shipping_cost }}</h3></td>
                    </tr>
                </table>

                <!-- FINAL WHATSAPP + PDF BUTTON -->
                <div class="mt-4">
                    <button onclick="placeWhatsAppOrder()" id="whatsapp-order-btn" class="th-btn btn-success w-100 py-4 fs-5">
                        Generate Invoice & Send Order via WhatsApp
                    </button>
                </div>
            </div>
        </div>

        {% else %}
        <div class="text-center py-5">
            <h3>Your cart is empty</h3>
            <a href="{% url 'shop:shop_list' %}" class="th-btn mt-3">Start Shopping</a>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function updateQuantity(id, change) {
    const input = document.querySelector(`input[name="quantity_${id}"]`);
    let val = parseInt(input.value) + change;
    if (val < 1) val = 1;
    input.value = val;
}

async function placeWhatsAppOrder() {
    const btn = document.getElementById('whatsapp-order-btn');
    btn.disabled = true;
    btn.innerHTML = "Generating Invoice...";

    try {
        const res = await fetch("{% url 'cart:create_whatsapp_order' %}", {
            method: 'POST',
            headers: {'X-CSRFToken': '{{ csrf_token }}'}
        });
        const data = await res.json();

        if (data.success) {
            // Download PDF
            const a = document.createElement('a');
            a.href = data.pdf_url;
            a.download = `Wamugunda_Invoice_${data.order_id}.pdf`;
            a.click();

            // Open WhatsApp
            setTimeout(() => window.open(data.whatsapp_url, '_blank'), 1500);

            alert(`Order #${data.order_id} Created!\nInvoice downloaded. Opening WhatsApp...`);
        } else {
            alert("Error: " + (data.error || "Try again"));
        }
    } catch (e) {
        alert("Network error. Try again.");
    }
    btn.disabled = false;
    btn.innerHTML = "Generate Invoice & Send Order via WhatsApp";
}
</script>
{% endblock %}